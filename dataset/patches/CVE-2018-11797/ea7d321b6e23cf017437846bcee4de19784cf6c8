From ea7d321b6e23cf017437846bcee4de19784cf6c8 Mon Sep 17 00:00:00 2001
From: Tilman Hausherr <tilman@apache.org>
Date: Thu, 27 Sep 2018 17:56:07 +0000
Subject: [PATCH] PDFBOX-4071: skip duplicates - CVE-2018-11797

git-svn-id: https://svn.apache.org/repos/asf/pdfbox/trunk@1842131 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/pdfbox/pdfparser/COSParser.java  | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java
index 75faddd9f38..9c3314e613d 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfparser/COSParser.java
@@ -2287,12 +2287,12 @@ protected void checkPages(COSDictionary root)
             COSBase pages = root.getDictionaryObject(COSName.PAGES);
             if (pages instanceof COSDictionary)
             {
-                checkPagesDictionary((COSDictionary) pages);
+                checkPagesDictionary((COSDictionary) pages, new HashSet<COSObject>());
             }
         }
     }
 
-    private int checkPagesDictionary(COSDictionary pagesDict)
+    private int checkPagesDictionary(COSDictionary pagesDict, Set<COSObject> set)
     {
         // check for kids
         COSBase kids = pagesDict.getDictionaryObject(COSName.KIDS);
@@ -2304,6 +2304,11 @@ private int checkPagesDictionary(COSDictionary pagesDict)
             for (COSBase kid : kidsList)
             {
                 COSObject kidObject = (COSObject) kid;
+                if (set.contains(kidObject))
+                {
+                    kidsArray.remove(kid);
+                    continue;
+                }
                 COSBase kidBaseobject = kidObject.getObject();
                 // object wasn't dereferenced -> remove it
                 if (kidBaseobject.equals(COSNull.NULL))
@@ -2318,7 +2323,8 @@ else if (kidBaseobject instanceof COSDictionary)
                     if (COSName.PAGES.equals(type))
                     {
                         // process nested pages dictionaries
-                        numberOfPages += checkPagesDictionary(kidDictionary);
+                        set.add(kidObject);
+                        numberOfPages += checkPagesDictionary(kidDictionary, set);
                     }
                     else if (COSName.PAGE.equals(type))
                     {
